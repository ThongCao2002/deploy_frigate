import{o as e,e as J,T as x,F as O,x as B,_,h as p,p as k,k as E,H as A,b as Z,u as z,c as q,g as G,i as L}from"./index-1b1f5707.js";import{J as K}from"./JSMpegPlayer-a228c7b4.js";import{L as Q}from"./Link-0ea49822.js";import{S as N}from"./Switch-baac240c.js";import{A as ee}from"./AutoUpdatingCameraImage-34b54836.js";import{l as $,e as te,P as ne}from"./Play-5837bbd3.js";import{v as ie}from"./video.es-306ef4f3.js";import"./index-aa83c415.js";function se({className:t}){return e("div",{className:`inline relative px-2 py-1 rounded-full ${t}`,children:[e("div",{className:"relative inline-block w-3 h-3 mr-2",children:e("span",{class:"flex h-3 w-3",children:[e("span",{class:"animate-ping absolute inline-flex h-full w-full rounded-full opacity-75",style:{backgroundColor:"rgb(74 222 128)"}}),e("span",{class:"relative inline-flex rounded-full h-3 w-3",style:{backgroundColor:"rgb(74 222 128)"}})]})}),e("span",{children:"Live"})]})}const re=Object.freeze({});function le({camera:t}){const[n,l]=J(`${t}-feed`,re),c=x((a,d)=>{const r={...n,[a]:d};l(r)},[n,l]),i=O(()=>new URLSearchParams(Object.keys(n).reduce((a,d)=>(a.push([d,n[d]===!0?"1":"0"]),a),[])),[n]),s=e("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:[e(N,{checked:n.bbox,id:"bbox",onChange:c,label:"Bounding box",labelPosition:"after"}),e(N,{checked:n.timestamp,id:"timestamp",onChange:c,label:"Timestamp",labelPosition:"after"}),e(N,{checked:n.zones,id:"zones",onChange:c,label:"Zones",labelPosition:"after"}),e(N,{checked:n.mask,id:"mask",onChange:c,label:"Masks",labelPosition:"after"}),e(N,{checked:n.motion,id:"motion",onChange:c,label:"Motion boxes",labelPosition:"after"}),e(N,{checked:n.regions,id:"regions",onChange:c,label:"Regions",labelPosition:"after"}),e(Q,{href:`/cameras/${t}/editor`,children:"Mask & Zone creator"})]});return e("div",{children:[e(ee,{camera:t,searchParams:i}),s]})}const oe=(t,n)=>n.startTime<t.endTime&&n.startTime>t.startTime,ae=(t,n)=>{const l=t[0],c=$(l.start_time);return t.map((i,s)=>{const a=$(i.start_time),d=i.end_time?$(i.end_time):new Date,r=Math.round(Math.abs(d.getTime()-a.getTime())/1e3),m=Math.round(Math.abs(a.getTime()-c.getTime())/1e3+n);return{...i,startTime:a,endTime:d,width:r,positionX:m,index:s}}).reduce((i,s)=>{for(let a=0;a<i.length;a++){const d=i[a]??[],r=d[d.length-1];if(!(r&&oe(r,s)))return i[a]=[...d,s],i}return i.push([s]),i},[]).flatMap((i,s)=>(i.forEach(a=>{a.yOffset=10*s}),i)).sort((i,s)=>i.startTime.getTime()-s.startTime.getTime())},ce=t=>t.reduce((n,l)=>l.yOffset>n?l.yOffset:n,0),de=(t,n)=>{const l=t[0];if(l){const c=l.startTime.getTime(),i=Date.now();return te(i-c)+n*2}return 0},ue=t=>t*parseFloat(getComputedStyle(document.documentElement).fontSize),me=t=>{const{label:n}=t;return n==="car"?"bg-red-400":n==="person"?"bg-blue-400":n==="dog"?"bg-green-400":"bg-gray-400"},fe=({block:t,onClick:n})=>{const l=x(()=>n(t),[t,n]);return e("div",{onClick:l,className:`absolute z-10 rounded-full ${me(t)} h-2`,style:{top:`${t.yOffset}px`,left:`${t.positionX}px`,width:`${t.width}px`}},t.id)},he=({timeline:t,firstBlockOffset:n,onEventClick:l})=>O(()=>{if(t.length>0&&n){const i=ce(t),s=i+ue(1),a=de(t,n),d=(s-i)/2;return e("div",{className:"relative",style:{height:`${s}px`,width:`${a}px`,background:"url('/images/marker.png')",backgroundPosition:"center",backgroundSize:"30px",backgroundRepeat:"repeat"},children:t.map(r=>{const m=y=>l(y),C={...r,yOffset:r.yOffset+d};return e(fe,{block:C,onClick:m},r.id)})})}return e("div",{})},[t,l,n]);function ge({className:t=""}){return e("svg",{className:`fill-current ${t}`,style:"width:24px;height:24px",viewBox:"0 0 24 24",children:e("path",{d:"M4,5V19L11,12M18,5V19H20V5M11,5V19L18,12"})})}const pe=B(ge);function ve({className:t=""}){return e("svg",{height:"24",viewBox:"0 0 24 24",width:"24",className:t,children:[e("path",{d:"M0 0h24v24H0V0z",fill:"none"}),e("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z",className:"fill-current"})]})}const Te=B(ve);function be(){return e("svg",{style:"width:24px;height:24px",viewBox:"0 0 24 24",children:e("path",{fill:"currentColor",d:"M20,5V19L13,12M6,5V19H4V5M13,5V19L6,12"})})}const xe=B(be),M=({variant:t="primary",children:n,onClick:l,disabled:c=!1,className:i=""})=>{const s="rounded-full px-4 py-2",a="text-white bg-blue-500 dark:text-black dark:bg-white",d="text-black dark:text-white bg-transparent";let r=s;return c?r+=" text-gray-200 dark:text-gray-200":t==="primary"?r+=` ${a}`:t==="secondary"&&(r+=` ${d}`),e("button",{onClick:()=>{c||l&&l()},className:`${r} ${i}`,children:n})},ke=({disabled:t,isPlaying:n,onPlayPause:l,onNext:c,onPrevious:i,className:s=""})=>{const a=()=>{l(!n)};return e("div",{className:`flex space-x-2 self-center ${s}`,children:[e(M,{variant:"secondary",onClick:i,disabled:t.previous,children:e(xe,{})}),e(M,{onClick:a,children:n?e(Te,{}):e(ne,{})}),e(M,{variant:"secondary",onClick:c,disabled:t.next,children:e(pe,{})})]})};function ye({events:t,isPlaying:n,onChange:l,onPlayPause:c}){const i=_(null),[s,a]=p([]),[d,r]=p({playPause:!1,next:!0,previous:!1}),[m,C]=p(0),[y,f]=p(new Date),[h,v]=p(void 0),[S,g]=p(),[T,P]=p({allowed:!0,resetAfterSeeked:!1}),D=x(o=>{i.current&&(P({allowed:!0,resetAfterSeeked:!0}),i.current.scroll({left:o,behavior:"smooth"}))},[i]),w=x((o,u=0)=>{D(o.positionX+u-m)},[m,D]);k(()=>{if(s.length>0&&h){const o=h.index;o===0?r(u=>({...u,next:!1,previous:!0})):o===s.length-1?r(u=>({...u,previous:!1,next:!0})):r(u=>({...u,previous:!1,next:!1}))}},[s,h]),k(()=>{if(t&&t.length>0&&m){const o=ae(t,m),u=o.length-1,b=o[u];a(o),f(b.startTime),v(b),w(b)}},[t,m,w]),k(()=>{if(s.length>0){const u=s[s.length-1];w(u)}},[s,w]);const F=o=>{const u=new Date(o);return u.setSeconds(o.getSeconds()+1),[...s].reverse().find(b=>b.startTime.getTime()<=u.getTime()&&b.endTime.getTime()>=u.getTime())},j=o=>{if(T.allowed){const u=F(o);v(u),l({markerTime:o,timelineEvent:u,seekComplete:!0})}T.resetAfterSeeked&&P({allowed:!0,resetAfterSeeked:!1})},R=o=>{S&&clearTimeout(S),g(setTimeout(()=>j(o),150))},I=()=>{if(i.current&&s.length>0){const o=H();f(o),R(o),l({timelineEvent:h,markerTime:o,seekComplete:!1})}},H=x(()=>{if(i.current&&s.length>0){const o=i.current.scrollLeft,b=s[0].startTime.getTime();return new Date(b+o*1e3)}return new Date},[s,i]);k(()=>{var o;if(i){const u=((o=i.current)==null?void 0:o.offsetWidth)||0,b=Math.round(u/2);C(b)}},[i]);const V=x(o=>{w(o),f(H())},[w,H]),W=o=>{c&&c(o)},X=()=>{if(h){const o=s[h.index-1];v(o),w(o)}},U=()=>{if(h){const o=s[h.index+1];v(o),w(o)}},Y=O(()=>{if(m&&s.length>0)return e(he,{timeline:s,firstBlockOffset:m,onEventClick:V})},[s,m,V]);return e(E,{children:[e("div",{className:"flex-grow-1",children:[e("div",{className:"w-full text-center",children:e("span",{className:"text-black dark:text-white",children:y&&e("span",{children:y.toLocaleTimeString()})})}),e("div",{className:"relative",children:[e("div",{className:"absolute left-0 top-0 h-full w-full text-center",children:e("div",{className:"h-full text-center",style:{margin:"0 auto"},children:e("div",{className:"z-20 h-full absolute",style:{left:"calc(100% / 2)",borderRight:"2px solid rgba(252, 211, 77)"}})})}),e("div",{ref:i,onScroll:I,className:"overflow-x-auto hide-scroll",children:Y})]})]}),e(ke,{disabled:d,isPlaying:n,onPrevious:X,onPlayPause:W,onNext:U,className:"mt-2"})]})}const we=({event:t,className:n=""})=>{let l="No Event Found",c=e("span",{children:"Event was not found at marker position."});if(t){const{startTime:i,endTime:s,label:a}=t,d=new Date;d.setHours(0,0,0);const r=s.getTime()>d.getTime();l=a,c=e("span",{children:[r?"Today":"Yesterday",", ",i.toLocaleTimeString()," - ",s.toLocaleTimeString()," Â·"]})}return e("div",{className:`text-center ${n}`,children:[e(A,{size:"lg",children:l}),e("div",{children:c})]})},Ce=t=>t==null,Ee=({id:t,isPlaying:n,currentTime:l,onTimeUpdate:c,onPause:i,onPlay:s})=>{const a=Z(),d=_(null),[r,m]=p();k(()=>{let f;d.current&&(f=ie(d.current,{}),m(f))},[d]),k(()=>{if(r){if(!t){r.pause();return}r.src({src:`${a}/vod/event/${t}/master.m3u8`,type:"application/vnd.apple.mpegurl"}),r.poster(`${a}/api/events/${t}/snapshot.jpg`),n&&r.play()}},[r,t,a,n]),k(()=>{const f=d.current,h=!Ce(f),v=l>=0;f&&h&&v&&(f.currentTime=l)},[l,d]);const C=x(f=>{const h=f.target,v={isPlaying:n,timestamp:h.currentTime};c&&c(v)},[n,c]);k(()=>{r&&r.readyState()>=1&&(n?r.play():r.pause())},[r,n]);const y=x(()=>{r&&r.readyState()>=1&&n&&r.play()},[r,n]);return e("div",{"data-vjs-player":!0,children:e("video",{ref:d,onTimeUpdate:C,onLoadedMetadata:y,onPause:i,onPlay:s,className:"video-js vjs-fluid","data-setup":"{}"})})};function Ne({camera:t}){const n={before:null,after:null,camera:t,label:"all",zone:"all"},l=(g,T)=>(T={...T,include_thumbnails:0,limit:500},q.get(g,{params:T}).then(P=>P.data)),{data:c}=z(["events",n],l),[i,s]=p([]),[a,d]=p(),[r,m]=p(!1),[C,y]=p(new Date().getTime());k(()=>{if(c){const g=[...c].reverse().filter(T=>T.end_time!==void 0);s(g)}},[c]);const f=x(g=>{if(g.seekComplete&&(d(g.timelineEvent),r&&g.timelineEvent)){const T=(g.markerTime.getTime()-g.timelineEvent.startTime.getTime())/1e3;y(T)}},[r]),h=()=>{m(!0)},v=()=>{m(!1)},S=g=>{m(g)};return e(E,{children:[e(E,{children:e("div",{className:"relative flex flex-col",children:e(E,{children:[e(we,{event:a,className:"mb-2"}),e(Ee,{id:a?a.id:void 0,isPlaying:r,currentTime:C,onPlay:h,onPause:v})]})})}),e(ye,{events:i,isPlaying:r,onChange:f,onPlayPause:S})]})}function Ve({camera:t}){const{data:n}=z("config"),[l,c]=p("live"),i=n==null?void 0:n.cameras[t],s=a=>{a===0?c("history"):a===1?c("live"):a===2&&c("debug")};return e("div",{className:"flex bg-white dark:bg-black w-full h-full justify-center",children:e("div",{className:"relative max-w-screen-md flex-grow w-full",children:[e("div",{className:"absolute top-0 text-white w-full",children:e("div",{className:"flex pt-4 pl-4 items-center w-full h-16 z10",children:(l==="live"||l==="debug")&&e(E,{children:[e(A,{size:"xl",className:"mr-2 text-black dark:text-white",children:t}),e(se,{className:"text-green-400 border-2 border-solid border-green-400 bg-opacity-40 dark:bg-opacity-10"})]})})}),e("div",{className:"flex flex-col justify-center h-full",children:e(Se,{camera:t,cameraConfig:i,playerType:l})}),e("div",{className:"absolute flex justify-center bottom-8 w-full",children:e(G,{selectedIndex:1,onChange:s,className:"justify",children:[e(L,{text:"History"}),e(L,{text:"Live"}),e(L,{text:"Debug"})]})})]})})}const Se=function({camera:t,cameraConfig:n,playerType:l}){const c=Math.round(n.live.height*(n.detect.width/n.detect.height));return l==="live"?e(E,{children:e("div",{children:e(K,{camera:t,width:c,height:n.live.height})})}):l==="history"?e(Ne,{camera:t}):l==="debug"?e(le,{camera:t}):e(E,{})};export{Ve as default};
