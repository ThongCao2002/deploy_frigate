import{T as m,p as w,o as n,f as b,x as v,u as y,h as g,j as S,H as f,d as T,A as D}from"./index-1b1f5707.js";import{A as C}from"./ArrowRightDouble-efaefc73.js";function W({camera:u,width:t,height:o}){const s=`${b.replace(/^http/,"ws")}live/webrtc/api/ws?src=${u}`,a=m(async i=>{const l=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),c=[];if(/camera|microphone/.test(i)&&(await r("user",{video:i.indexOf("camera")>=0,audio:i.indexOf("microphone")>=0})).forEach(h=>{l.addTransceiver(h,{direction:"sendonly"}),h.kind==="video"&&c.push(h)}),i.indexOf("display")>=0&&(await r("display",{video:!0,audio:i.indexOf("speaker")>=0})).forEach(h=>{l.addTransceiver(h,{direction:"sendonly"}),h.kind==="video"&&c.push(h)}),/video|audio/.test(i)){const e=["video","audio"].filter(h=>i.indexOf(h)>=0).map(h=>l.addTransceiver(h,{direction:"recvonly"}).receiver.track);c.push(...e)}return document.getElementById("video").srcObject=new MediaStream(c),l},[]);async function r(i,l){try{return(i==="user"?await navigator.mediaDevices.getUserMedia(l):await navigator.mediaDevices.getDisplayMedia(l)).getTracks()}catch{return[]}}const d=m(async()=>{const i=await a("video+audio"),l=new WebSocket(s);l.addEventListener("open",()=>{i.addEventListener("icecandidate",c=>{if(!c.candidate)return;const e={type:"webrtc/candidate",value:c.candidate.candidate};l.send(JSON.stringify(e))}),i.createOffer().then(c=>i.setLocalDescription(c)).then(()=>{const c={type:"webrtc/offer",value:i.localDescription.sdp};l.send(JSON.stringify(c))})}),l.addEventListener("message",c=>{const e=JSON.parse(c.data);e.type==="webrtc/candidate"?i.addIceCandidate({candidate:e.value,sdpMid:"0"}):e.type==="webrtc/answer"&&i.setRemoteDescription({type:"answer",sdp:e.value})})},[a,s]);return w(()=>{d()},[d]),n("div",{children:n("video",{id:"video",autoplay:!0,playsinline:!0,controls:!0,muted:!0,width:t,height:o})})}class p extends HTMLElement{constructor(){super(),this.DISCONNECT_TIMEOUT=5e3,this.RECONNECT_TIMEOUT=3e4,this.CODECS=["avc1.640029","avc1.64002A","avc1.640033","hvc1.1.6.L153.B0","mp4a.40.2","mp4a.40.5","flac","opus"],this.mode="webrtc,mse,mp4,mjpeg",this.background=!1,this.visibilityThreshold=0,this.visibilityCheck=!0,this.pcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"}],sdpSemantics:"unified-plan"},this.wsState=WebSocket.CLOSED,this.pcState=WebSocket.CLOSED,this.video=null,this.ws=null,this.wsURL="",this.pc=null,this.connectTS=0,this.mseCodecs="",this.disconnectTID=0,this.reconnectTID=0,this.ondata=null,this.onmessage=null}set src(t){typeof t!="string"&&(t=t.toString()),t.startsWith("http")?t=`ws${t.substring(4)}`:t.startsWith("/")&&(t=`ws${location.origin.substring(4)}${t}`),this.wsURL=t,this.onconnect()}play(){this.video.play().catch(t=>{t.name==="NotAllowedError"&&!this.video.muted&&(this.video.muted=!0,this.video.play().catch(()=>{}))})}send(t){this.ws&&this.ws.send(JSON.stringify(t))}codecs(t){const o=t==="mse"?s=>MediaSource.isTypeSupported(`video/mp4; codecs="${s}"`):s=>this.video.canPlayType(`video/mp4; codecs="${s}"`);return this.CODECS.filter(o).join()}connectedCallback(){if(this.disconnectTID&&(clearTimeout(this.disconnectTID),this.disconnectTID=0),this.video){const t=this.video.seekable;t.length>0&&(this.video.currentTime=t.end(t.length-1)),this.play()}else this.oninit();this.onconnect()}disconnectedCallback(){this.background||this.disconnectTID||this.wsState===WebSocket.CLOSED&&this.pcState===WebSocket.CLOSED||(this.disconnectTID=setTimeout(()=>{this.reconnectTID&&(clearTimeout(this.reconnectTID),this.reconnectTID=0),this.disconnectTID=0,this.ondisconnect()},this.DISCONNECT_TIMEOUT))}oninit(){this.video=document.createElement("video"),this.video.controls=!0,this.video.playsInline=!0,this.video.preload="auto",this.video.style.display="block",this.video.style.width="100%",this.video.style.height="100%",this.appendChild(this.video),!this.background&&("hidden"in document&&this.visibilityCheck&&document.addEventListener("visibilitychange",()=>{document.hidden?this.disconnectedCallback():this.isConnected&&this.connectedCallback()}),"IntersectionObserver"in window&&this.visibilityThreshold&&new IntersectionObserver(o=>{o.forEach(s=>{s.isIntersecting?this.isConnected&&this.connectedCallback():this.disconnectedCallback()})},{threshold:this.visibilityThreshold}).observe(this))}onconnect(){return!this.isConnected||!this.wsURL||this.ws||this.pc?!1:(this.wsState=WebSocket.CONNECTING,this.connectTS=Date.now(),this.ws=new WebSocket(this.wsURL),this.ws.binaryType="arraybuffer",this.ws.addEventListener("open",t=>this.onopen(t)),this.ws.addEventListener("close",t=>this.onclose(t)),!0)}ondisconnect(){this.wsState=WebSocket.CLOSED,this.ws&&(this.ws.close(),this.ws=null),this.pcState=WebSocket.CLOSED,this.pc&&(this.pc.close(),this.pc=null)}onopen(){this.wsState=WebSocket.OPEN,this.ws.addEventListener("message",o=>{if(typeof o.data=="string"){const s=JSON.parse(o.data);for(const a in this.onmessage)this.onmessage[a](s)}else this.ondata(o.data)}),this.ondata=null,this.onmessage={};const t=[];return this.mode.indexOf("mse")>=0&&"MediaSource"in window?(t.push("mse"),this.onmse()):this.mode.indexOf("mp4")>=0&&(t.push("mp4"),this.onmp4()),this.mode.indexOf("webrtc")>=0&&"RTCPeerConnection"in window&&(t.push("webrtc"),this.onwebrtc()),this.mode.indexOf("mjpeg")>=0&&(t.length?this.onmessage.mjpeg=o=>{o.type!=="error"||o.value.indexOf(t[0])!==0||this.onmjpeg()}:(t.push("mjpeg"),this.onmjpeg())),t}onclose(){if(this.wsState===WebSocket.CLOSED)return!1;this.wsState=WebSocket.CONNECTING,this.ws=null;const t=Math.max(this.RECONNECT_TIMEOUT-(Date.now()-this.connectTS),0);return this.reconnectTID=setTimeout(()=>{this.reconnectTID=0,this.onconnect()},t),!0}onmse(){const t=new MediaSource;t.addEventListener("sourceopen",()=>{URL.revokeObjectURL(this.video.src),this.send({type:"mse",value:this.codecs("mse")})},{once:!0}),this.video.src=URL.createObjectURL(t),this.video.srcObject=null,this.play(),this.mseCodecs="",this.onmessage.mse=o=>{if(o.type!=="mse")return;this.mseCodecs=o.value;const s=t.addSourceBuffer(o.value);s.mode="segments",s.addEventListener("updateend",()=>{if(!s.updating)try{if(r>0){const d=a.slice(0,r);r=0,s.appendBuffer(d)}else if(s.buffered&&s.buffered.length){const d=s.buffered.end(s.buffered.length-1)-15,i=s.buffered.start(0);d>i&&(s.remove(i,d),t.setLiveSeekableRange(d,d+15))}}catch{}});const a=new Uint8Array(2*1024*1024);let r=0;this.ondata=d=>{if(s.updating||r>0){const i=new Uint8Array(d);a.set(i,r),r+=i.byteLength}else try{s.appendBuffer(d)}catch{}}}}onwebrtc(){const t=new RTCPeerConnection(this.pcConfig),o=document.createElement("video");o.addEventListener("loadeddata",s=>this.onpcvideo(s),{once:!0}),t.addEventListener("icecandidate",s=>{const a=s.candidate?s.candidate.toJSON().candidate:"";this.send({type:"webrtc/candidate",value:a})}),t.addEventListener("track",s=>{o.srcObject===null&&s.streams.length!==0&&s.streams[0].id[0]!=="{"&&(o.srcObject=s.streams[0])}),t.addEventListener("connectionstatechange",()=>{(t.connectionState==="failed"||t.connectionState==="disconnected")&&(t.close(),this.pcState=WebSocket.CLOSED,this.pc=null,this.onconnect())}),this.onmessage.webrtc=s=>{switch(s.type){case"webrtc/candidate":t.addIceCandidate({candidate:s.value,sdpMid:"0"}).catch(()=>{});break;case"webrtc/answer":t.setRemoteDescription({type:"answer",sdp:s.value}).catch(()=>{});break;case"error":if(s.value.indexOf("webrtc/offer")<0)return;t.close()}},t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"}),t.createOffer().then(s=>{t.setLocalDescription(s).then(()=>{this.send({type:"webrtc/offer",value:s.sdp})})}),this.pcState=WebSocket.CONNECTING,this.pc=t}onpcvideo(t){if(!this.pc)return;const o=t.target,s=this.pc.connectionState;if(s==="connected"||s==="connecting"||!s){let a=0,r=0;const d=o.srcObject;d.getVideoTracks().length>0&&(a+=544),d.getAudioTracks().length>0&&(a+=258),this.mseCodecs.indexOf("hvc1.")>=0&&(r+=560),this.mseCodecs.indexOf("avc1.")>=0&&(r+=528),this.mseCodecs.indexOf("mp4a.")>=0&&(r+=257),a>=r?(this.video.srcObject=d,this.play(),this.pcState=WebSocket.OPEN,this.wsState=WebSocket.CLOSED,this.ws.close(),this.ws=null):(this.pcState=WebSocket.CLOSED,this.pc.close(),this.pc=null)}o.srcObject=null}onmjpeg(){this.ondata=t=>{this.video.controls=!1,this.video.poster=`data:image/jpeg;base64,${p.btoa(t)}`},this.send({type:"mjpeg"})}onmp4(){const t=document.createElement("canvas");let o;const s=document.createElement("video");s.autoplay=!0,s.playsInline=!0,s.muted=!0,s.addEventListener("loadeddata",a=>{o||(t.width=s.videoWidth,t.height=s.videoHeight,o=t.getContext("2d")),o.drawImage(s,0,0,t.width,t.height),this.video.controls=!1,this.video.poster=t.toDataURL("image/jpeg")}),this.ondata=a=>{s.src=`data:video/mp4;base64,${p.btoa(a)}`},this.send({type:"mp4",value:this.codecs("mp4")})}static btoa(t){const o=new Uint8Array(t),s=o.byteLength;let a="";for(let r=0;r<s;r++)a+=String.fromCharCode(o[r]);return window.btoa(a)}}class k extends p{oninit(){super.oninit();const t=this.querySelector(".info");this.insertBefore(this.video,t)}onconnect(){const t=super.onconnect();return t&&(this.divMode="loading"),t}ondisconnect(){super.ondisconnect()}onopen(){const t=super.onopen();return this.onmessage.stream=o=>{},t}onclose(){return super.onclose()}onpcvideo(t){super.onpcvideo(t),this.pcState!==WebSocket.CLOSED&&(this.divMode="RTC")}}customElements.define("video-stream",k);function O({className:u=""}){return n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:`${u}`,children:n("path",{d:"M4.5 12.75l7.5-7.5 7.5 7.5m-15 6l7.5-7.5 7.5 7.5"})})}const E=v(O);function N({className:u=""}){return n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:`${u}`,children:n("path",{d:"M19.5 5.25l-7.5 7.5-7.5-7.5m15 6l-7.5 7.5-7.5-7.5"})})}const L=v(N);function x({className:u=""}){return n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:`${u}`,children:n("path",{d:"M18.75 19.5l-7.5-7.5 7.5-7.5m-6 15L5.25 12l7.5-7.5"})})}const I=v(x);function j({camera:u=""}){const{data:t}=y(`${u}/ptz/info`),[o,s]=g(""),{payload:a,send:r}=S(u),d=async e=>{e.stopPropagation(),o!="none"&&(r(`preset_${o}`),s(""))},i=async(e,h)=>{e.stopPropagation(),r(`MOVE_${h}`),s("")},l=async(e,h)=>{e.stopPropagation(),r(`ZOOM_${h}`),s("")},c=async e=>{e.stopPropagation(),r("STOP")};return t?(document.addEventListener("keydown",e=>{if(e){if(e.repeat){e.preventDefault();return}t.features.includes("pt")&&(e.key==="ArrowLeft"?(e.preventDefault(),i(e,"LEFT")):e.key==="ArrowRight"?(e.preventDefault(),i(e,"RIGHT")):e.key==="ArrowUp"?(e.preventDefault(),i(e,"UP")):e.key==="ArrowDown"&&(e.preventDefault(),i(e,"DOWN")),t.features.includes("zoom")&&(e.key=="+"?(e.preventDefault(),l(e,"IN")):e.key=="-"&&(e.preventDefault(),l(e,"OUT"))))}}),document.addEventListener("keyup",e=>{!e||e.repeat||(e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="ArrowUp"||e.key==="ArrowDown"||e.key==="+"||e.key==="-")&&(e.preventDefault(),c(e))}),n("div",{"data-testid":"control-panel",className:"p-4 text-center sm:flex justify-start",children:[t.features.includes("pt")&&n("div",{className:"flex justify-center",children:n("div",{className:"w-44 px-4",children:[n(f,{size:"xs",className:"my-4",children:"Pan / Tilt"}),n("div",{className:"w-full flex justify-center",children:n("button",{onMouseDown:e=>i(e,"UP"),onMouseUp:e=>c(e),onTouchStart:e=>{i(e,"UP"),e.preventDefault()},onTouchEnd:e=>{c(e),e.preventDefault()},children:n(E,{className:"h-12 p-2 bg-slate-500"})})}),n("div",{className:"w-full flex justify-between",children:[n("button",{onMouseDown:e=>i(e,"LEFT"),onMouseUp:e=>c(e),onTouchStart:e=>{i(e,"LEFT"),e.preventDefault()},onTouchEnd:e=>{c(e),e.preventDefault()},children:n(I,{className:"btn h-12 p-2 bg-slate-500"})}),n("button",{onMouseDown:e=>i(e,"RIGHT"),onMouseUp:e=>c(e),onTouchStart:e=>{i(e,"RIGHT"),e.preventDefault()},onTouchEnd:e=>{c(e),e.preventDefault()},children:n(C,{className:"h-12 p-2 bg-slate-500"})})]}),n("div",{className:"flex justify-center",children:n("button",{onMouseDown:e=>i(e,"DOWN"),onMouseUp:e=>c(e),onTouchStart:e=>{i(e,"DOWN"),e.preventDefault()},onTouchEnd:e=>{c(e),e.preventDefault()},children:n(L,{className:"h-12 p-2 bg-slate-500"})})})]})}),t.features.includes("zoom")&&n("div",{className:"px-4 sm:w-44",children:[n(f,{size:"xs",className:"my-4",children:"Zoom"}),n("div",{className:"w-full flex justify-center",children:n("button",{onMouseDown:e=>l(e,"IN"),onMouseUp:e=>c(e),onTouchStart:e=>{l(e,"IN"),e.preventDefault()},onTouchEnd:e=>{c(e),e.preventDefault()},children:n("div",{className:"h-12 w-12 p-2 text-2xl bg-slate-500 select-none",children:"+"})})}),n("div",{className:"h-12"}),n("div",{className:"flex justify-center",children:n("button",{onMouseDown:e=>l(e,"OUT"),onMouseUp:e=>c(e),onTouchStart:e=>{l(e,"OUT"),e.preventDefault()},onTouchEnd:e=>{c(e),e.preventDefault()},children:n("div",{className:"h-12 w-12 p-2 text-2xl bg-slate-500 select-none",children:"-"})})})]}),(t.presets||[]).length>0&&n("div",{className:"px-4",children:[n(f,{size:"xs",className:"my-4",children:"Presets"}),n("div",{className:"py-4",children:n("select",{className:"cursor-pointer rounded dark:bg-slate-800",value:o,onChange:e=>{s(e.target.value)},children:[n("option",{value:"",children:"Select Preset"}),t.presets.map(e=>n("option",{value:e,children:e.charAt(0).toUpperCase()+e.slice(1)},e))]})}),n(T,{onClick:e=>d(e),children:"Move Camera To Preset"})]})]})):n(D,{})}export{j as C,W};
