import{u as de,_ as Y,h as N,a as he,T as c,o as s,H as L,B as K,b as ue,c as B,F as pe,d as q}from"./index-1b1f5707.js";import{S as fe}from"./Switch-baac240c.js";function Me({camera:n}){const{data:o}=de("config"),l=ue(),i=Y(null),[b,x]=N(!0),C=o.cameras[n],{motion:{mask:k},objects:{filters:m},zones:O}=C,{width:j,height:v}=C.detect,[{width:g}]=he(i),u=g/j,[y,w]=N(Array.isArray(k)?k.map(t=>z(t)):k?[z(k)]:[]),[p,P]=N(Object.keys(O).reduce((t,e)=>({...t,[e]:z(O[e].coordinates)}),{})),[d,r]=N(Object.keys(m).reduce((t,e)=>({...t,[e]:Array.isArray(m[e].mask)?m[e].mask.map(h=>z(h)):m[e].mask?[z(m[e].mask)]:[]}),{})),[a,f]=N({set:y,key:0,fn:w}),[T,A]=N(),[F,E]=N(),R=c(t=>{let e;Array.isArray(a.set)?(e=[...a.set],e[a.key]=t):a.subkey!==void 0?(e={...a.set},e[a.key][a.subkey]=t):e={...a.set,[a.key]:t},a.set=e,a.fn(e)},[a]),W=c(()=>{const t=[...y,[]];w(t),f({set:t,key:t.length-1,fn:w})},[y,w]),V=c(t=>{f({set:y,key:t,fn:w})},[f,y,w]),X=c(t=>{const e=[...y];e.splice(t,1),w(e)},[y,w]),U=c(()=>{const t=`  motion:
      mask:
  ${y.map(e=>`      - ${S(e)}`).join(`
`)}`;if(window.navigator.clipboard&&window.navigator.clipboard.writeText)window.navigator.clipboard.writeText(t).catch(e=>{throw new Error("Failed to copy text: ",e)});else{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select();try{if(!document.execCommand("copy"))throw new Error("Failed to copy text")}catch(h){throw new Error("Failed to copy text: ",h)}document.body.removeChild(e)}},[y]),G=c(async()=>{try{const e=`config/set?${y.map(($,_)=>`cameras.${n}.motion.mask.${_}=${S($)}`).join("&")}`,h=await B.put(e);h.status===200&&A(h.data)}catch(t){t.response?E(t.response.data.message):E(t.message)}},[n,y]),J=c(t=>{f({set:p,key:t,fn:P})},[f,p,P]),Q=c(()=>{const e=`zone_${Object.keys(p).filter($=>$.startsWith("zone_")).length}`,h={...p,[e]:[]};P(h),f({set:h,key:e,fn:P})},[p,P]),ee=c(t=>{const e={...p};delete e[t],P(e)},[p,P]),te=c(async()=>{const t=`  zones:
${Object.keys(p).map(e=>`    ${e}:
      coordinates: ${S(p[e])}`).join(`
`)}`;if(window.navigator.clipboard&&window.navigator.clipboard.writeText)window.navigator.clipboard.writeText(t).catch(e=>{throw new Error("Failed to copy text: ",e)});else{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select();try{if(!document.execCommand("copy"))throw new Error("Failed to copy text")}catch(h){throw new Error("Failed to copy text: ",h)}document.body.removeChild(e)}},[p]),ne=c(async()=>{try{const e=`config/set?${Object.keys(p).map($=>`cameras.${n}.zones.${$}.coordinates=${S(p[$])}`).join("&")}`,h=await B.put(e);h.status===200&&A(h.data)}catch(t){t.response?E(t.response.data.message):E(t.message)}},[n,p]),se=c((t,e)=>{f({set:d,key:t,subkey:e,fn:r})},[f,d,r]),oe=c(()=>{const e=`object_${Object.keys(d).filter($=>$.startsWith("object_")).length}`,h={...d,[e]:[[]]};r(h),f({set:h,key:e,subkey:0,fn:r})},[d,r,f]),ae=c((t,e)=>{const h={...d};delete h[t][e],r(h)},[d,r]),re=c(async()=>{await window.navigator.clipboard.writeText(`  objects:
    filters:
${Object.keys(d).map(t=>d[t].length?`      ${t}:
        mask: ${S(d[t])}`:"").filter(Boolean).join(`
`)}`)},[d]),ce=c(async()=>{try{const e=`config/set?${Object.keys(d).filter($=>d[$].length>0).map(($,_)=>`cameras.${n}.objects.filters.${$}.mask.${_}=${S(d[$])}`).join("&")}`,h=await B.put(e);h.status===200&&A(h.data)}catch(t){t.response?E(t.response.data.message):E(t.message)}},[n,d]),ie=c(t=>{const e={...d,[t]:[...d[t],[]]};r(e),f({set:e,key:t,subkey:e[t].length-1,fn:r})},[d,r,f]),le=c((t,e)=>{x(e)},[x]);return s("div",{className:"flex-col space-y-4 p-2 px-4",children:[s(L,{size:"2xl",children:[n," Tạo vùng nhận diện và loại bỏ"]}),s(K,{content:s("div",{children:[s("p",{children:["Công cụ giúp tạo vùng che cho camera ",n]}),s("ul",{children:[s("li",{children:"Nhấn chuột trái để tạo 1 điểm."}),s("li",{children:"Nhấn giữ chuột trái để di chuyển điểm đó."}),s("li",{children:"Nhấn chuột phải để xóa điểm bất kì."})]})]}),header:"Hướng dẫn"}),s(K,{content:s("p",{children:["Sau khi hoàn thành, sao chép cấu hình từng vùng che vào file ",s("code",{className:"font-mono",children:"config.yml"})," để lưu và khởi động lại hệ thống."]}),header:"Lưu ý"}),T&&s("div",{className:"max-h-20 text-green-500",children:T}),F&&s("div",{className:"p-4 overflow-scroll text-red-500 whitespace-pre-wrap",children:F}),s("div",{className:"space-y-4",children:[s("div",{className:"relative",children:[s("img",{ref:i,src:`${l}/api/${n}/latest.jpg`}),s(ke,{onChange:R,points:"subkey"in a?a.set[a.key][a.subkey]:a.set[a.key],scale:u,snap:b,width:j,height:v})]}),s("div",{className:"max-w-xs",children:s(fe,{checked:b,label:"Khớp vào các cạnh",labelPosition:"after",onChange:le})})]}),s("div",{className:"flex-col space-y-4",children:[s(H,{editing:a,title:"Vùng loại bỏ nhận diện chuyển động",onCopy:U,onSave:G,onCreate:W,onEdit:V,onRemove:X,points:y,yamlPrefix:`motion:
  mask:`,yamlKeyPrefix:ye}),s(H,{editing:a,title:"Vùng nhận diện",onCopy:te,onSave:ne,onCreate:Q,onEdit:J,onRemove:ee,points:p,yamlPrefix:"zones:",yamlKeyPrefix:me}),s(H,{isMulti:!0,editing:a,title:"Vùng loại bỏ nhận diện vật thể",onAdd:ie,onCopy:re,onSave:ce,onCreate:oe,onEdit:se,onRemove:ae,points:d,yamlPrefix:`objects:
  filters:`,yamlKeyPrefix:ge})]})]})}function ye(){return"    - "}function me(n,o){return`  ${o}:
    coordinates: `}function ge(){return"        - "}const M=20;function Z(n,o,l){const i=Math.min(Math.max(0,Math.round(n)),o);if(l){if(i<=M)return 0;if(o-i<=M)return o}return i}function ke({onChange:n,points:o,scale:l,snap:i,width:b,height:x}){const C=Y(null),k=c((v,g,u)=>{if(g<0&&u<0)return;const y=Z(g/l,b,i),w=Z(u/l,x,i),p=[...o];p[v]=[y,w],n(p)},[x,b,n,l,o,i]),m=c(v=>{const{offsetX:g,offsetY:u}=v,y=Z((g-M)/l,b,i),w=Z((u-M)/l,x,i),p=[y,w],{index:P}=o.reduce((r,a,f)=>{const T=o.length===f+1?o[0]:o[f+1],A=Math.sqrt(Math.pow(a[0]-p[0],2)+Math.pow(a[1]-p[1],2)),F=Math.sqrt(Math.pow(a[0]-T[0],2)+Math.pow(a[1]-T[1],2)),E=A+F;return E<r.distance?{distance:E,index:f}:r},{distance:1/0,index:-1}),d=[...o];d.splice(P,0,p),n(d)},[x,b,l,o,n,i]),O=c(v=>{const g=[...o];g.splice(v,1),n(g)},[o,n]),j=pe(()=>be(o,l),[o,l]);return s("div",{className:"absolute",style:`top: -${M}px; right: -${M}px; bottom: -${M}px; left: -${M}px`,children:[j?j.map(([v,g],u)=>s(xe,{boundingRef:C,index:u,onMove:k,onRemove:O,x:v+M,y:g+M},u)):null,s("div",{className:"absolute inset-0 right-0 bottom-0",onClick:m,ref:C}),s("svg",{width:"100%",height:"100%",className:"absolute pointer-events-none",style:`top: ${M}px; right: ${M}px; bottom: ${M}px; left: ${M}px`,children:j?s("g",{children:s("polyline",{points:S(j),fill:"rgba(244,0,0,0.5)"})}):null})]})}function H({isMulti:n=!1,editing:o,title:l,onAdd:i,onCopy:b,onSave:x,onCreate:C,onEdit:k,onRemove:m,points:O,yamlPrefix:j,yamlKeyPrefix:v}){const[g,u]=N(!1),y=c(()=>{u(!0)},[u]),w=c(r=>{const a=r.toElement||r.relatedTarget;!a||a.parentNode===r.target||u(!1)},[u]),p=c(r=>{const{key:a,subkey:f}=r.target.dataset;k(a,f)},[k]),P=c(r=>{const{key:a,subkey:f}=r.target.dataset;m(a,f)},[m]),d=c(r=>{const{key:a}=r.target.dataset;i(a)},[i]);return s("div",{className:"overflow-hidden",onMouseOver:y,onMouseOut:w,children:[s("div",{className:"flex space-x-4",children:[s(L,{className:"flex-grow self-center",size:"base",children:l}),s(q,{onClick:b,children:"Sao chép"}),s(q,{onClick:C,children:"Thêm"}),s(q,{onClick:x,children:"Lưu"})]}),s("pre",{className:"relative overflow-auto font-mono text-gray-900 dark:text-gray-100 rounded bg-gray-100 dark:bg-gray-800 p-2",children:[j,Object.keys(O).map(r=>n?s("div",{children:[`    ${r}:
      mask:
`,i&&g?s(q,{className:"absolute -mt-12 right-0 font-sans","data-key":r,onClick:d,children:`Thêm vào ${r}`}):null,O[r].map((a,f)=>s(I,{mainkey:r,subkey:f,editing:o,handleEdit:p,handleRemove:P,points:a,showButtons:g,yamlKeyPrefix:v},f))]},r):s(I,{mainkey:r,editing:o,handleAdd:i?d:void 0,handleEdit:p,handleRemove:P,points:O[r],showButtons:g,yamlKeyPrefix:v},r))]})]})}function I({mainkey:n,subkey:o,editing:l,handleEdit:i,points:b,showButtons:x,_handleAdd:C,handleRemove:k,yamlKeyPrefix:m}){return s("span",{"data-key":n,"data-subkey":o,className:`block hover:text-blue-400 cursor-pointer relative ${l.key===n&&l.subkey===o?"text-blue-800 dark:text-blue-600":""}`,onClick:i,title:"Chỉnh sửa",children:[`${m(b,n,o)}${S(b)}`,x?s(q,{className:"absolute top-0 right-0",color:"red","data-key":n,"data-subkey":o,onClick:k,children:"Xóa"}):null]})}function z(n){if(n)return n.split(",").reduce((o,l,i)=>(i%2?o[o.length-1].push(parseInt(l,10)):o.push([parseInt(l,10)]),o),[])}function be(n,o){if(n)return n.map(([l,i])=>[Math.round(l*o),Math.round(i*o)])}function S(n){if(n)return n.reduce((o,[l,i])=>`${o}${l},${i},`,"").replace(/,$/,"")}const D=10;function xe({boundingRef:n,index:o,x:l,y:i,onMove:b,onRemove:x}){const[C,k]=N(!1),m=c(u=>{!n.current||u.target!==n.current&&!n.current.contains(u.target)||b(o,u.layerX-D*2,u.layerY-D*2)},[b,o,n]),O=c(()=>{n.current&&n.current.addEventListener("dragover",m,!1),k(!0)},[k,n,m]),j=c(()=>{n.current&&n.current.removeEventListener("dragover",m),k(!1)},[k,n,m]),v=c(u=>{u.preventDefault(),x(o)},[x,o]),g=c(u=>{u.stopPropagation(),u.preventDefault()},[]);return s("div",{className:`${C?"opacity-0":""} bg-gray-900 rounded-full absolute z-20`,style:`top: ${i-D}px; left: ${l-D}px; width: 20px; height: 20px;`,draggable:!0,onClick:g,onContextMenu:v,onDragStart:O,onDragEnd:j})}export{Me as default};
